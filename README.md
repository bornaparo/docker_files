# docker_files for using baxter robot

Docker files for creating ros1 and ros2 containers which can be used to send joint trajectories generated by moveit2 to a real baxter robot.

## Prerequisites
Follow these [instructions](https://docs.docker.com/engine/install/ubuntu/) to install docker engine.

Then follow these [optional steps](https://docs.docker.com/engine/install/linux-postinstall/#manage-docker-as-a-non-root-user) to manage docker as a non-root user. If you skip this, every `docker` command will have to be executed with `sudo`. Skip the _"Note: To run Docker without root privileges, see Run the Docker daemon as a non-root user (Rootless mode)."_ part. This is just a note and we do not need it.

To be able to run graphical applications inside a container, execute in terminal
```bash
xhost +local:docker
```
To avoid having to do this every time, add this command to your `.profile` file which executes on every login.
```bash
echo "xhost +local:docker > /dev/null" >> ~/.profile
```

## Installation
#### Clone the project
```bash
git clone https://github.com/bornaparo/docker_files.git
export DOCKER_FILES_DIR=$(readlink -f docker_files)
```
#### Create ros1_baxter container
Position yourself in the `ros1_baxter` directory and build the image
```bash
cd $DOCKER_FILES_DIR/ros1_baxter
docker build -t ros1_baxter_img:latest .
```
Wait for it to finish, it will take some time.

Create the container
```bash
bash first_run.sh
```
If everything went well, your terminal prompt should change from
```
<your username>@<your hostname>
```
to
```
developer@<your hostname>
```

#### Create ros2_baxter container
Position yourself in the `ros2_baxter` directory and build the image
```bash
cd $DOCKER_FILES_DIR/ros2_baxter
docker build -t ros2_baxter_img:latest .
```

Wait for it to finish, it will take some time (a lot :)).

Create the container
```bash
bash run_docker.sh
```
If everything went well, your terminal prompt should change from
```
<your username>@<your hostname>
```
to
```
developer@<your hostname>
```

## Starting containers
After the containers are created with the scripts, you can start exited containers with
```bash
docker start -i ros1_baxter
docker start -i ros2_baxter
```
If you want to open more container terminals after starting containers, do it with
```bash
docker exec -it ros1_baxter bash
docker exec -it ros2_baxter bash
```

## Exiting containers
If you want to exit the container, enter in terminal `exit` and you terminal prompt should change from 
```
developer@<your hostname>
```
to
```
<your username>@<your hostname>
```
Note: if you stop the container with `docker container stop <container-id>` all the data inside the container created after running it will be lost.

## Post building
Plug in Baxter's power cable and make sure that Baxter's red button is **not pressed, you have to unclick it before turning on Baxter**. Turn on Baxter by pressing the power button on the rear side of the robot and connect it to your workstation using ethernet cable.

### Setting up the network
Go to network settings on Ubuntu and choose "Add a new connection". In IPv4 settings, instead of the default "Automatic (DHCP)" setting, choose "Manual". Add any static IP address (e.g. 192.168.2.101), Netmask 24 and set 192.168.2.1 as Gateway. Save your new network and choose this setting in your network manager every time you are connected to Baxter. If you are connected successfully, you will not have internet connection (since your LAN connection goes to Baxter and not the router). But you can also connect to the wifi while the baxter's ethernet cable is connected and communication will still work.

### Setting up communication with Baxter
In the `ros1_baxter` container, open the `baxter.sh` script for editing. As "your_ip" set the static IP address you chose while configuring the network, e.g. `your_ip="192.168.2.101"` Baxter's hostname is defaulted as the robot's serial number. In our case, we set `baxter_hostname="011404P0015.local`". Set "ros_version" parameter to `noetic`.

### Connecting to Baxter
Run the baxter.sh script
```bash
bash baxtex.sh
```
Note: that script needs to be run in every `ros1_baxter` container terminal with which you want to communicate with baxter.

If everything went well, the `rostopic list` command should give you a list of all Baxter topics.

See if you are receiving messages from the baxter, for example
```bash
rostopic echo /usb/ready
```
If something is printing out then everything is working.

## Using it with ROS2 MoveIt2
For using real baxter with MoveIt2 and ROS2, start these nodes

**ros1_baxter container**:
- `rosrun baxter_tools enable_robot.py -e`
- `rosrun baxter_tools tuck_arms.py -u` if the arms are tucked
- `rosrun baxter_ros1_bridge sub_pub_joint_state.py`
- `rosrun baxter_interface joint_trajectory_action_server.py` and wait for it to bring up
- `rosrun baxter_ros1_bridge baxter_action_client_bridge.py`

**ros2_baxter container**:
- `ros2 run baxter_bridge bridge`

After starting above nodes, you can start your moveit2 example that utilizes `baxter_moveit2_adapter` package, or your own way of sending joint trajectory from ros2 moveit2 to ros1 that communicates with baxter.

For example:

**ros2_baxter container**:
- `ros2 launch baxter_moveit_config baxter_moveit_opaque.launch.py using_real_baxter:=True`
- `ros2 launch baxter_moveit2_examples baxter_moveit2_examples.launch.py`

If everything loads well, you should see baxter in rviz with the same pose as the real baxter and arms should move in rviz the same way that real baxter arms are moving.

## Troubleshooting
TODO

## Credits
Dockerfiles and run scripts were modified by following solutions from these repositories:
[larics - docker_files](https://github.com/larics/docker_files), 
[CroboticSolutions - docker_files](https://github.com/CroboticSolutions/docker_files/tree/master)